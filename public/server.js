'use strict';function Hc(a,b){this.g=a;this.i=b;this.F=0;this.s=[];this.D=[];this.currentTime=this.h=0}function Ic(a){a.currentTime=Date.now()/1E3-a.h}function Jc(a,b){this.g=a;this.h=b}var Kc=0,Lc=[];function Mc(a){var b=Nc(!0);this.i=a;this.h=b;this.g=Oc(b,25,25);this.D=[]}function Pc(a){let b=a.h.g;Ic(b);b.F=a.g.v;b.D.length=0;var c=a.D,e=b.D;0<c.length&&(e.push.apply(e,c),c.length=0);a.i.emit("update",b)}
function Qc(){this.j=Kc++;this.l=1E4*Math.random()|0;this.B=1;this.i=[];this.h=new sa(this.l);this.g=new Hc(this.j,this.l);this.m=0;if(0!==this.j){for(var a=0;19>a;a++){var b=Oc(this,-400+800*(oa(this.h.g)/2147483647),-400+800*(oa(this.h.g)/2147483647));b.name=da();b.N=!0}a=ta(this.h,6,40,.5);for(b=0;b<a.length;b++)Rc(this,6,a[b].x,a[b].y,a[b].z);a=ta(this.h,7,40,.5);for(b=0;b<a.length;b++)Rc(this,7,a[b].x,a[b].y,a[b].z)}}
function Rc(a,b,c,e,d,f,k,g){b=new ea(b,c,e,d,f,k,g);b.v=a.B++;a.g.s.push(b);return b}function Oc(a,b,c){a=Rc(a,2,b,n(a.h,b,c)+1,c);a.C=30;a.u=0;a.j=0;a.m=0;return a}function Sc(a,b){var c=a.i;c.splice(c.indexOf(b),1);a=a.g.s;a.splice(a.indexOf(b.g),1)}function Xc(a,b){for(let c=0;c<a.i.length;c++)a.i[c].D.push(b)}
function bd(a,b,c,e,d){if(!(0>=b.C)){var f=Math.hypot(c,e,d);c=c/f*10;e=e/f*10;d=d/f*10;f=Rc(a,3,b.x,b.y+.5,b.z,c,e,d);f.l=b.v;b.u=10;b.C--;b=new ea(13,f.x+.05*c,f.y+.05*e,f.z+.05*d);b.l=f.l;Xc(a,b)}}
function cd(a,b,c,e,d){var f=Math.hypot(c,e,d);c/=f;e/=f;d/=f;let k=f,g=null;for(var h=0;h<a.g.s.length;h++){var l=a.g.s[h];if(!(2!==l.A||l.v===b.v||l.v===b.l||0>=l.o)){var p=dd(c,e,d,b.x-l.x,b.y-l.y,b.z-l.z,1,f);null!==p&&p<k&&(k=p,g=l)}}for(h=0;h<a.h.l.length;h++)l=a.h.l[h],p=dd(c,e,d,b.x-l.x,b.y-l.y,b.z-l.z,.8,f),null!==p&&p<k&&(k=p,g=l);for(h=0;h<a.h.i.length;h++)l=a.h.i[h],p=dd(c,e,d,b.x-l.x,b.y-(l.y-4.2),b.z-l.z,.8,f),null!==p&&p<k&&(k=p,g=l);for(f=0;f<k;f+=.1)if(b.y+f*e<n(a.h,b.x+f*c,b.z+f*
d)){k=f;g=fa;break}return g?new Jc(g,k):null}function ed(a,b,c){if(0>=b.o){b.o=0;b.H=wa(a.g)+1;let e=new ea(15,b.x,b.y,b.z);e.v=b.v;e.l=c;Xc(a,e)}}function dd(a,b,c,e,d,f,k,g){var h=a*a+b*b+c*c;a=2*(a*e+b*d+c*f);d=e*e+d*d+f*f-k*k;if(0>a*a-4*h*d)return null;e=(-1*a+Math.sqrt(Math.pow(a,2)-4*h*d))/(2*h);h=(-1*a-Math.sqrt(Math.pow(a,2)-4*h*d))/(2*h);return 0<=e&&e<g||0<=h&&h<g?Math.min(e,h):0<=e&&e<g?e:0<=h&&h<g?h:null}
function fd(a,b,c){let e=c.x-b.x;c=c.z-b.z;let d=Math.hypot(e,c);b.h=e/d*8/30;b.i=c/d*8/30;b.x+=b.h;b.z+=b.i;b.y=n(a.h,b.x,b.z)+1;b.j=Math.atan2(b.h,b.i)}function gd(a,b,c,e,d,f){let k=null;f=f||a.g.s;for(let h=0;h<f.length;h++){let l=f[h];if(b!==l&&l.A===c&&0<l.o&&(!d||!ra(d,l))){var g=l.x-b.x;let p=l.y-b.y,v=l.z-b.z,aa=Math.hypot(g,v);aa<e&&(g=cd(a,b,g,p,v),g&&g.g!==l||(k=l,e=aa))}}return k}
function Nc(a){for(var b=a?0:1;b<Lc.length;b++){var c;(c=a)||(c=Lc[b],Ic(c.g),c=-3>c.g.currentTime);if(c)return Lc[b]}a=new Qc;a.g.h=Date.now()/1E3+5;Lc.push(a);return a}
setInterval(function(){for(let aa=Lc.length-1;0<aa;aa--){var a=Lc[aa];if(0===a.i.length)Lc.splice(aa,1);else if(Ic(a.g),0<=a.g.currentTime&&!(1>=wa(a.g))){var b=va(a.h,a.g.currentTime),c=ua(a.h,a.g.currentTime);for(let ma=a.g.s.length-1;0<=ma;ma--){var e=a.g.s[ma];if(0>=e.o)continue;let na=!1;switch(e.A){case 2:0<e.u&&e.u--;if(e.N){var d=a,f=e,k=b,g=c;f.h=f.g=f.i=0;var h=gd(d,f,2,40),l=gd(d,f,6,20,k),p=gd(d,f,4,40,g,d.h.i);ra(k,f)?fd(d,f,g):0===f.u&&h?(fd(d,f,h),bd(d,f,h.x-f.x+.2*Math.random()-.1,
h.y-f.y+.2*Math.random()-.1,h.z-f.z+.2*Math.random()-.1)):l?fd(d,f,l):ra(g,f)?fd(d,f,g):p&&(k=Date.now()/3E3*2*m,fd(d,f,{x:p.x+3*Math.cos(k),z:p.z+3*Math.sin(k)}))}0==a.m%33&&ra(b,e)&&(e.o-=5,ed(a,e));break;case 3:d=a;f=e;h=f.h;l=f.g;var v=f.i;g=Math.hypot(h,l,v);p=h/g;k=l/g;g=v/g;if(h=cd(d,f,h,l,v))switch(l=h.g,v=h.h,l.A){case 2:l.o-=25,ed(d,l,f.l),Xc(d,new ea(14,f.x+v*p,f.y+v*k,f.z+v*g))}(d=!!h)&&(na=!0);e.x+=e.h;e.y+=e.g;e.z+=e.i;if(-500>e.x||500<e.x||-500>e.z||500<e.z)na=!0;break;case 6:case 7:if(d=
gd(a,e,2,1))6===e.A?d.C+=30:d.o=Math.min(100,d.o+50),e=new ea(16,e.x,e.y,e.z),e.l=d.v,Xc(a,e),na=!0}na&&a.g.s.splice(ma,1)}a.m++}}},33);
module.exports=function(a){const b=new Mc(a);a.on("update",function(c){if(c&&void 0!==c.x&&void 0!==c.y&&void 0!==c.z){b.g.name=c.name;b.g.j=c.j;b.g.x=c.x;b.g.y=c.y;b.g.z=c.z;b.g.h=c.h;b.g.g=c.g;b.g.i=c.i;if(c.actions)for(let f=0;f<c.actions.length;f++){var e=c.actions[f];switch(e.A){case 8:e=Nc();var d=b;d.h&&Sc(d.h,d);e.i.push(d);d.h=e;d.g=Oc(e,25,25);break;case 9:bd(b.h,b.g,e.h,e.g,e.i)}}Pc(b)}});a.on("disconnect",function(){Sc(b.h,b)});Pc(b)};
